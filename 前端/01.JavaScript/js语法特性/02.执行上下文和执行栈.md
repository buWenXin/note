

# 执行上下文和执行栈

**执行上下文：**

> JavaScript 代码是按顺序从上到下被解析的，当然 JavaScript 引擎并非逐行的分析和执行代码，而是逐段的去分析和执行。当执行一段代码时，都会进行预编译，创建这段代码的执行上下文。
>
> **执行上下文是一个对象，是一个用来描述当前代码运行环境的对象**。它是在代码的*预编译阶段创建的*，用来指导执行器如何执行代码。
>
> 执行上下文分为：全局执行上下文和函数执行上下文。
>
> 执行上下文中存储了：变量对象、作用域链和 this。
>
> 注意：*函数对象还存在于变量中，所以函数对象不会随着执行上下文一起被销毁。*

```ts
function fn1() {
   let name = 'tom';
   console.log(name);
}

fn1();//执行到这里，发现是要执行一个函数，就会启动编译器对这个函数进行预编译
```

上面的代码的执行的过程是：

- 执行到 fn1()的时候，发现是要执行一个函数，就会启动编译器对这个函数进行预编译
- 在进行预编译的时候,会创建一个属于这个*函数的执行上下文对象*。
- 编译器会将这个函数的 *函数对象、 this、作用域链等信息*存入到这个执行上下文对象中去，然后将这个执行上下文对象push到*函数执行栈中去执行*。



## 执行栈：

> 执行栈又叫*执行上下文栈*，它是一种*后进先出*的数据结构。执行栈中存储的元素是*执行上下文对象*，所有要执行的函数，都会先进行预编译，生成对应的函数执行上下文对象，然后将执行上下文对象*推入到执行栈中执行*，函数执行完成后，又会将函数的执行上下文对象从*执行栈中移除*。

- js代码在执行之前，会先调用预编译器对全局代码进行预编译，生成全局执行上下文对象，然后将执行上下文对象推入到执行栈中去执行。
- 在执行全局代码的时候，如果遇到了要执行函数，也会去调用预编译器去对函数进行预编译，生成函数的执行上下文对象，然后将函数执行上下文对象推入到执行栈中执行。
- 在执行函数的时候，如果又在函数内部遇到要执行的函数，则会和上面一样，对函数进行预编译，生成函数的执行上下文对象，推入到执行栈中执行。
- 当函数执行完后，就会将函数从执行栈中移除，然后继续执行执行栈中的其他函数。
- 最后，所有的代码都执行完毕，执行栈中只剩下全局执行上下文对象。（*注意：全局执行上下文对象在代码执行完毕后并不会出栈，只有当页面关闭的时候才会出栈*。）

```js
<script>
   function fn1() {
      let name = 'tom';
      console.log(name);
      fn2();
   }

   function fn2() {
      console.log("我是fn2");
   }

   fn1();
</script>
```



1. 当浏览器在代执行JavaScript代码的时候，会先去预编译全局代码，创建全局执行上下文对象，然后将全局执行上下文对象推入到执行栈中执行。
2. 全局执行上下文对象推入到执行栈中，js的执行器开始执行代码，在执行到11行的时候，发现要执行的是一个函数`fn1()`
3. 此时就会对使用编译器对这个函数进行预编译，创建函数执行上下文对象，然后将执行上下文对象推入到执行栈中执行。
4. 在执行`fn1`函数的时候，又发现要执行一个函数，重复上面的步骤：预编译函数，推入到执行栈中执行。
5. 执行`fn2`函数，当fn2执行完毕后，就会将fn2的执行上下文对象从执行栈中移除销毁。（出栈）
6. `fn2`出栈后会回来继续执行`fn1`，`fn1`执行完成后，将fn1出栈销毁。
7. 最后所以代码执行完毕，此时执行栈中就只剩下了全局执行上下文对象。
8. 全局执行上下文在代码执行完毕后并不好出栈，而是只有当页面销毁的时候才会出栈销毁。



**预编译做了什么：**

- 确定this的指向
- 函数提升 变量提升
- 确定作用域链

## 总结：

- 执行上下文是一个专业术语，比较抽象，实际上就是在内存中开辟的一块独立运行的空间。执行上下文栈相当于一个数组，数组元素就是一个个独立的执行上下文对象。

- 当 JavaScript 开始解释程序时，最先遇到的是全局代码，因此在初始化程序的时候，首先向执行上下文栈压入一个全局执行上下文，并且只有当整个应用程序结束的时候，全局执行上下文才被清空。

- 当执行一个函数的时候，会创建一个函数的执行上下文，并且压入到执行上下文栈，当函数执行完毕，会将函数的执行上下文栈中弹出。

- 每个执行上下文都有 3 个基本属性：变量对象、作用域链和 this。
- 变量对象是与执行上下文相关的数据作用域，存储了在上下文中定义的变量和函数声明。JavaScript 代码不能直接访问该对象，但是可以访问该对象的成员（如 arguments）。不同代码段中的变量对象也不相同，简单说明如下。、



- 创建全局执行上下文，将全局执行上下文推入到栈中执行，